/* cifar10_nn.c */
#include "cifar10_nn.h"
#include <math.h>

// CIFAR-10 class names - short versions for LCD display
const char* cifar10_class_names[10] = {
    "plane", "car", "bird", "cat", "deer",
    "dog", "frog", "horse", "ship", "truck"
};

// FC1 Weight [16][48] - You need to replace these with trained weights
static const float fc1_weight[16][48] = {
  {0.140643f, 0.370779f, 0.207211f, 0.301830f, 0.355699f, -0.132263f, 0.001261f, 0.101041f, 0.233104f, -0.406295f, -0.258633f, 0.240719f, 0.290452f, 0.373387f, 0.486291f, 0.332828f, 0.003436f, -0.079500f, 0.088761f, -0.099205f, 0.221413f, -0.959390f, -0.832753f, 0.364048f, 0.726724f, 0.222441f, 0.194760f, 0.572565f, 0.054222f, 0.115254f, 0.051673f, -0.088631f, -0.330814f, -0.126101f, -0.088545f, -0.412941f, -0.142096f, 0.091080f, 0.166346f, -0.034425f, -0.474815f, 0.297437f, 0.121526f, -0.447193f, -0.810943f, -0.479479f, -0.307036f, -0.865551f},
  {0.249383f, -0.036493f, 0.078032f, 0.027064f, -0.167832f, -1.434983f, -1.200080f, 0.027482f, -0.079946f, -0.872800f, -0.929983f, -0.176318f, 0.182282f, 0.073465f, 0.174344f, 0.249315f, -0.044314f, 0.098213f, -0.010932f, -0.043919f, 0.113480f, 0.454176f, 0.398714f, 0.099079f, -0.160843f, 0.168375f, 0.211253f, -0.123157f, -0.072588f, 0.004660f, -0.061682f, -0.098332f, 0.005554f, 0.076921f, 0.070515f, -0.135269f, -0.042536f, 1.111989f, 0.957936f, -0.123234f, 0.233882f, 1.097104f, 0.884964f, 0.224907f, -0.265487f, -0.132690f, -0.015817f, -0.252056f},
  {-0.019601f, 0.003770f, -0.128040f, -0.073309f, 0.524983f, -0.250411f, -0.361596f, 0.477608f, 0.247551f, -0.521534f, -0.355866f, 0.237974f, 0.219623f, -0.046741f, -0.071958f, 0.277149f, -0.147992f, -0.066622f, -0.203225f, -0.170721f, -0.001201f, -0.391165f, -0.251352f, 0.096211f, 0.047012f, 0.141881f, 0.079557f, 0.012837f, -0.203938f, -0.117331f, -0.153574f, -0.245653f, 0.168249f, 0.408129f, 0.264778f, 0.225493f, 0.168122f, -0.249175f, -0.272105f, 0.202415f, 0.291955f, -0.169094f, -0.107532f, 0.653094f, 0.403297f, 0.845320f, 0.791721f, 0.344222f},
  {-0.096349f, 0.004795f, 0.045146f, -0.266205f, 0.088383f, -0.357750f, -0.365523f, 0.294103f, 0.759162f, 1.349462f, 1.208893f, 0.670421f, -0.528749f, -0.545381f, -0.526302f, -0.575416f, -0.068096f, -0.014620f, 0.018359f, 0.044588f, -0.165293f, -0.619104f, -0.294586f, -0.030199f, 0.190561f, 0.423632f, 0.556608f, 0.228025f, -0.257522f, -0.337490f, -0.342085f, -0.420996f, 0.322660f, 0.011872f, 0.121396f, 0.265317f, -0.416444f, -0.077129f, -0.090452f, -0.206065f, -0.053261f, 0.242964f, -0.030241f, -0.015297f, 0.107504f, -0.437383f, -0.365880f, 0.105275f},
  {-0.196910f, -0.462827f, -0.341942f, -0.192764f, -0.490680f, 0.136015f, 0.150832f, -0.555762f, -0.290620f, -0.029512f, 0.070800f, -0.333023f, -0.579724f, -0.132785f, 0.092399f, -0.499638f, -0.252000f, -0.159789f, -0.311899f, -0.133382f, -0.395572f, 0.068468f, 0.177498f, -0.083033f, 0.062602f, 0.139385f, 0.284215f, 0.020890f, -0.103672f, 0.465067f, 0.395677f, -0.259455f, 0.544077f, 0.524785f, 0.437869f, 0.426667f, 0.339822f, 0.171816f, 0.185165f, 0.264766f, 0.071379f, -0.256613f, -0.182838f, 0.093179f, 0.242996f, 0.233600f, 0.398517f, 0.107255f},
  {0.052528f, -0.008892f, -0.008655f, -0.186144f, -0.025819f, -0.388831f, -0.363294f, -0.201882f, -0.009483f, 0.399573f, 0.499682f, -0.123498f, -0.111613f, -0.009677f, 0.047763f, 0.143138f, -0.167732f, 0.394922f, 0.478498f, 0.000914f, 0.219592f, 0.958523f, 0.839555f, 0.291762f, -0.005200f, -0.180827f, -0.275734f, 0.202296f, 0.427743f, 0.141317f, 0.022409f, 0.260134f, -0.711561f, -0.283246f, -0.220371f, -0.578014f, -0.387618f, 0.052062f, 0.088282f, -0.368964f, -0.244538f, -0.327527f, -0.215446f, -0.086813f, -0.416568f, -0.251088f, -0.165848f, -0.419770f},
  {0.135579f, -0.044446f, -0.034972f, 0.047470f, 0.607179f, 0.131662f, 0.216273f, 0.570943f, -0.105940f, 0.383810f, 0.458743f, -0.037694f, -0.043653f, -0.336337f, -0.293884f, -0.023173f, 0.359913f, 0.040052f, 0.149710f, 0.269414f, 0.247417f, 0.290221f, 0.176823f, 0.195496f, -0.791624f, -0.896854f, -0.870852f, -0.568643f, 0.124609f, -0.060684f, -0.049979f, -0.087123f, 0.344540f, -0.010959f, -0.202373f, 0.163886f, 0.005536f, 0.541048f, 0.537092f, -0.237955f, -0.318681f, -0.035748f, 0.101453f, -0.361178f, 0.126927f, -0.029304f, 0.022457f, 0.186840f},
  {0.150338f, -0.081154f, -0.243078f, -0.089339f, 0.006377f, 0.283958f, 0.454680f, 0.016258f, -0.317447f, 0.603234f, 0.572176f, -0.032332f, 0.288915f, -0.021069f, -0.055146f, 0.369555f, 0.073698f, -0.202928f, -0.308866f, 0.124721f, 0.044884f, 0.024293f, 0.025220f, -0.119437f, -0.652505f, -0.144451f, 0.015914f, -0.693120f, 0.204714f, -0.004567f, 0.030932f, 0.273009f, 0.266428f, -0.166062f, -0.140151f, 0.364949f, 0.219100f, -1.006533f, -0.841997f, 0.205994f, 0.062480f, -0.473474f, -0.564402f, -0.129059f, 0.378265f, -0.076727f, -0.081851f, 0.119497f},
  {-0.044794f, 0.028987f, -0.059762f, -0.053868f, 0.308234f, 0.166105f, -0.051302f, 0.239071f, -0.247142f, -0.055769f, -0.147824f, -0.142557f, 0.160970f, -0.036393f, -0.113168f, 0.137666f, -0.308092f, -0.287730f, -0.148624f, -0.310353f, 0.062310f, -0.636731f, -0.637669f, 0.148625f, 0.040271f, -0.519252f, -0.509965f, 0.097101f, 0.288928f, 0.543467f, 0.448031f, 0.273051f, -0.285856f, -0.202079f, -0.050856f, -0.227790f, 0.033083f, 0.877671f, 0.946067f, 0.228312f, 0.135643f, 0.142788f, 0.193213f, 0.210166f, -0.082332f, -0.120349f, -0.195010f, 0.002946f},
  {-0.140098f, 0.165495f, 0.115460f, -0.009920f, -0.316740f, 0.181905f, 0.166036f, -0.323490f, -0.142733f, 0.192490f, 0.092594f, -0.063267f, -0.655707f, 0.042555f, -0.040532f, -0.711994f, 0.063110f, 0.149845f, 0.072136f, -0.049349f, 0.079742f, 0.500884f, 0.560639f, 0.071191f, 0.239832f, -0.103737f, 0.007428f, 0.470878f, 0.253024f, 0.018909f, -0.099600f, 0.298135f, -0.099646f, -0.007412f, 0.189068f, -0.147390f, 0.487122f, -0.154323f, -0.168620f, 0.174325f, 0.500338f, -0.484471f, -0.603921f, 0.439774f, 0.755529f, -0.017752f, -0.126234f, 0.708750f},
  {-0.478945f, -0.583930f, -0.458944f, -0.391096f, 0.058776f, 0.538615f, 0.554524f, 0.163647f, 0.328393f, 0.088958f, 0.049634f, 0.366548f, 0.271880f, -0.144937f, -0.103922f, 0.273118f, -0.049779f, 0.163730f, 0.184821f, 0.150954f, -0.204648f, -0.678466f, -0.647750f, -0.447184f, -0.079478f, -0.012761f, -0.060575f, -0.255196f, 0.120193f, 0.759448f, 0.669469f, 0.130939f, 0.700126f, 0.693228f, 0.542688f, 0.780284f, -0.294909f, 0.240469f, 0.221650f, -0.513328f, -0.566843f, -0.298412f, -0.183820f, -0.319309f, -0.580389f, -0.014402f, 0.073548f, -0.554352f},
  {-0.048874f, 0.326366f, 0.278932f, 0.237702f, -0.096752f, 0.007818f, 0.030683f, -0.254001f, -0.222145f, 0.338278f, 0.290643f, -0.022391f, -0.449464f, 0.708193f, 0.714736f, -0.388164f, -0.061738f, -0.075324f, -0.165077f, -0.202727f, -0.009945f, 0.113455f, 0.201934f, 0.032145f, -0.541276f, 0.338796f, 0.285459f, -0.359660f, -0.856907f, 0.238424f, 0.203672f, -0.700632f, -0.044261f, -0.051385f, 0.136493f, -0.183978f, 0.034158f, -0.158727f, -0.228828f, 0.013256f, -0.326297f, 0.522874f, 0.451799f, -0.399130f, -0.288724f, 0.687801f, 0.811520f, -0.139846f},
  {-0.268889f, 0.305225f, 0.172168f, -0.408495f, -0.489305f, 0.964418f, 1.128130f, -0.587172f, -0.162246f, -0.122489f, -0.224122f, 0.036142f, -0.054707f, -0.058773f, -0.151898f, 0.050155f, -0.191982f, -0.047387f, 0.023473f, -0.197188f, -0.551054f, 0.834938f, 0.806831f, -0.601902f, -0.033967f, 0.527025f, 0.380856f, 0.021894f, -0.001210f, -0.009358f, -0.119383f, 0.124350f, -0.069263f, 0.081362f, 0.001863f, -0.129419f, -0.364325f, 0.619553f, 0.749156f, -0.353249f, -0.139134f, 0.191296f, 0.127546f, -0.115413f, 0.199173f, -0.152254f, -0.152349f, 0.068508f},
  {0.091291f, 0.002592f, -0.075989f, 0.277513f, 0.717935f, -0.541631f, -0.476367f, 0.727601f, 0.267234f, -0.075647f, 0.037418f, 0.219509f, 0.307653f, -0.368202f, -0.339349f, 0.253892f, 0.169493f, -0.077378f, 0.026336f, 0.128873f, 0.021030f, 0.050607f, 0.033167f, 0.163371f, -0.685502f, -0.778562f, -0.682187f, -0.536974f, 0.156823f, -0.522785f, -0.339170f, 0.194882f, -0.121873f, -0.299186f, -0.179643f, 0.175331f, -0.194521f, 0.163934f, 0.272224f, -0.190421f, -0.342136f, 0.104034f, 0.192398f, -0.275687f, 0.508019f, -0.060583f, -0.128278f, 0.606824f},
  {0.309468f, 0.025951f, 0.042282f, 0.391625f, 0.157186f, -0.225963f, -0.239420f, 0.125436f, 0.043588f, -0.258335f, -0.238397f, 0.060025f, 0.424162f, 0.337911f, 0.337156f, 0.422113f, -0.029869f, -0.078467f, -0.126796f, -0.102468f, -0.065229f, 0.997945f, 1.026143f, -0.101438f, -0.242270f, 0.409277f, 0.324329f, -0.020275f, -0.051118f, 0.154916f, 0.073232f, 0.136397f, -0.154815f, -0.222873f, -0.164170f, -0.033205f, 0.057154f, -0.246172f, -0.143556f, -0.057667f, -0.376469f, -0.188912f, -0.357399f, -0.426514f, -0.696983f, -0.404139f, -0.370112f, -0.754516f},
  {-0.115235f, -0.168506f, -0.181022f, -0.084600f, -0.549527f, 0.360639f, 0.342064f, -0.324197f, -0.181326f, -0.458392f, -0.440693f, -0.175105f, 0.464242f, 0.083380f, 0.110756f, 0.445297f, 0.247062f, -0.066860f, 0.076303f, 0.335989f, 0.536405f, -0.519497f, -0.484136f, 0.618725f, 0.577201f, 0.413895f, 0.391655f, 0.716400f, 0.164556f, 0.085322f, -0.081181f, 0.186831f, 0.014753f, 0.090601f, 0.076556f, 0.013632f, 0.160841f, -0.348197f, -0.443420f, 0.020275f, -0.438533f, -0.091473f, -0.104895f, -0.350060f, -0.570166f, -0.508075f, -0.377946f, -0.579124f},
};

// FC1 Bias [16]
static const float fc1_bias[16] = {
  0.457704f,
  0.756918f,
  0.210021f,
  -0.077151f,
  0.618720f,
  0.445226f,
  0.008296f,
  0.463166f,
  0.502281f,
  0.594198f,
  0.129040f,
  0.370334f,
  0.005073f,
  0.361740f,
  0.314068f,
  0.647973f
};

// FC2 Weight [10][16]
static const float fc2_weight[10][16] = {
  {0.068896f, 0.412652f, 0.655114f, 0.139268f, 0.514659f, -0.308528f, 0.006085f, -0.692730f, 0.076996f, -0.030979f, 0.399249f, -0.896821f, -0.311016f, -0.136123f, 0.969116f, -0.658805f},
  {-0.866242f, 1.328779f, 0.086870f, 0.753449f, -1.274133f, 0.982008f, 0.476010f, 0.182513f, 0.658246f, -0.911853f, 0.665414f, -0.886171f, -0.416689f, 0.678970f, -0.352933f, -1.312218f},
  {0.297541f, -0.232779f, 0.236695f, -0.876978f, 0.511327f, 0.260490f, -0.721711f, -0.407441f, -0.453167f, 0.387741f, -0.962166f, -0.087068f, -0.451785f, -0.209207f, 0.320830f, 0.525771f},
  {0.246363f, -0.916626f, 0.125519f, -0.383032f, -0.066158f, -0.601122f, -0.466269f, 0.338066f, 0.012407f, 0.161152f, -0.952901f, 0.720430f, 0.257635f, 0.270332f, 0.245263f, -0.138288f},
  {0.054215f, -0.579053f, -0.251934f, -0.627236f, 0.293515f, 0.587857f, -0.042308f, 0.153349f, 0.378460f, 0.227562f, -0.220588f, -0.490142f, -0.925377f, -1.028713f, 0.139120f, 0.323282f},
  {0.677185f, -0.984270f, -0.170627f, -0.474560f, -0.403904f, -0.285646f, -0.591637f, 0.093629f, -0.008256f, 0.344934f, -0.636674f, 0.775652f, 0.681954f, 0.114644f, -0.481421f, 0.029639f},
  {-0.408923f, -1.451433f, 0.369071f, -0.776948f, -0.047956f, 0.350547f, -0.854680f, 0.747162f, -1.355926f, 0.163386f, -1.497394f, -0.028993f, 0.140509f, -0.031269f, 0.592839f, 0.178549f},
  {0.596476f, -0.876638f, 0.028878f, -0.522291f, -0.422529f, -0.644501f, -0.021891f, -0.064585f, 0.895694f, -0.697282f, 0.678071f, -0.546262f, 0.988355f, -0.706676f, -0.474744f, 0.797345f},
  {-1.215405f, -0.005432f, -0.864906f, 0.623485f, 0.472921f, -0.093625f, 0.456818f, -0.666819f, -0.058836f, 0.720225f, -0.043386f, 0.135000f, -0.622913f, 0.349351f, -0.526734f, -0.400411f},
  {-1.059581f, 0.775724f, -0.181805f, 0.444658f, -0.793213f, -0.025676f, 0.501023f, 0.260882f, -0.123973f, -0.830163f, 0.774483f, -0.664703f, 0.137527f, 0.485478f, -0.384182f, -0.121909f},
};

// FC2 Bias [10]
static const float fc2_bias[10] = {
  -0.409098f,
  -0.111894f,
  0.049985f,
  0.172347f,
  0.053171f,
  0.100290f,
  0.270326f,
  -0.114456f,
  0.183375f,
  0.060185f
};

// Neural network inference function (CIFAR-10)
int cifar10_classify(uint8_t inputNN[32][32][3], float *confidence)
{
    // Step 1: Average pooling to reduce 32x32x3 to 4x4x3 = 48 features
    float pooled_features[48];

    for (int c = 0; c < 3; c++) {  // For each channel (R, G, B)
        for (int y = 0; y < 4; y++) {  // 4x4 output
            for (int x = 0; x < 4; x++) {
                float sum = 0.0f;
                // Average over 8x8 window
                for (int dy = 0; dy < 8; dy++) {
                    for (int dx = 0; dx < 8; dx++) {
                        int input_y = y * 8 + dy;
                        int input_x = x * 8 + dx;
                        sum += (float)inputNN[input_y][input_x][c] / 255.0f; // Normalize to [0,1]
                    }
                }
                int output_idx = c * 16 + y * 4 + x;  // 4x4x3 flattened
                pooled_features[output_idx] = (sum / 64.0f) * 2.0f - 1.0f; // Normalize to [-1,1]
            }
        }
    }

    // Step 2: First fully connected layer (48 -> 16)
    float fc1_output[16];
    for (int i = 0; i < 16; i++) {
        fc1_output[i] = fc1_bias[i];
        for (int j = 0; j < 48; j++) {
            fc1_output[i] += fc1_weight[i][j] * pooled_features[j];
        }
        // ReLU activation
        fc1_output[i] = fc1_output[i] > 0.0f ? fc1_output[i] : 0.0f;
    }

    // Step 3: Second fully connected layer (16 -> 10)
    float fc2_output[10];
    for (int i = 0; i < 10; i++) {
        fc2_output[i] = fc2_bias[i];
        for (int j = 0; j < 16; j++) {
            fc2_output[i] += fc2_weight[i][j] * fc1_output[j];
        }
    }

    // Step 4: Softmax (find max for numerical stability)
    float max_val = fc2_output[0];
    for (int i = 1; i < 10; i++) {
        if (fc2_output[i] > max_val) {
            max_val = fc2_output[i];
        }
    }

    // Calculate softmax probabilities
    float sum = 0.0f;
    float probabilities[10];
    for (int i = 0; i < 10; i++) {
        probabilities[i] = expf(fc2_output[i] - max_val);
        sum += probabilities[i];
    }

    // Normalize probabilities
    for (int i = 0; i < 10; i++) {
        probabilities[i] /= sum;
    }

    // Find the class with highest probability
    int predicted_class = 0;
    float max_confidence = probabilities[0];
    for (int i = 1; i < 10; i++) {
        if (probabilities[i] > max_confidence) {
            max_confidence = probabilities[i];
            predicted_class = i;
        }
    }

    // Return the confidence score
    *confidence = max_confidence;

    return predicted_class;
}
