/*
 * cifar10_nn.c
 *
 *  Created on: May 26, 2025
 *      Author: HoangHai
 */

#include "cifar10_nn.h"
#include <math.h>

// CIFAR-10 class names - short versions for LCD display
const char* cifar10_class_names[10] = {
    "plane", "car", "bird", "cat", "deer",
    "dog", "frog", "horse", "ship", "truck"
};

// FC1 Weight [16][48]
float fc1_weight[16][48] = {
  {0.195916f, 0.117193f, 0.175567f, 0.080772f, 0.129142f, -1.559925f, -1.529610f, 0.228696f, -0.061644f, -0.512805f, -0.768012f, -0.098784f, 0.214114f, -0.094679f, 0.085331f, 0.269409f, 0.061427f, 0.058159f, 0.297234f, -0.069187f, 0.064541f, 0.348937f, 0.290223f, 0.243055f, -0.267274f, -0.210895f, -0.006424f, -0.261051f, 0.134673f, 0.087906f, -0.004878f, -0.157893f, -0.207047f, -0.122685f, -0.194729f, -0.263230f, -0.166483f, 1.052294f, 1.039735f, -0.268831f, 0.228060f, 1.124537f, 1.228130f, 0.171261f, -0.384371f, -0.026735f, -0.104329f, -0.135277f},
  {0.013199f, 0.170680f, 0.146235f, 0.177924f, 0.862252f, -0.211215f, -0.055311f, 0.749135f, 0.179208f, -0.511397f, -0.578008f, 0.173735f, 0.009767f, -0.080607f, -0.006929f, -0.009777f, 0.084035f, 0.023819f, 0.001402f, -0.012992f, 0.004089f, 0.308314f, 0.289004f, -0.050013f, -0.608218f, -0.911264f, -0.881328f, -0.564581f, 0.243025f, 0.278572f, 0.256508f, 0.144295f, -0.109678f, -0.200807f, -0.162290f, 0.125796f, -0.079232f, 0.201886f, 0.362277f, -0.047356f, -0.045128f, -0.222887f, -0.166131f, 0.027543f, 0.167335f, 0.364615f, 0.308843f, 0.291683f},
  {0.097325f, 0.116199f, 0.146569f, -0.174399f, 0.359240f, -0.549617f, -0.405655f, 0.386884f, 0.715403f, 1.526024f, 1.545323f, 0.595936f, -0.709444f, -0.457257f, -0.494111f, -0.651203f, -0.014921f, 0.318394f, 0.186034f, 0.015517f, 0.187995f, -0.425594f, -0.443118f, 0.143847f, -0.139935f, -0.285657f, -0.366584f, -0.012200f, -0.189250f, -0.356022f, -0.291334f, -0.099681f, -0.095635f, -0.136149f, 0.092544f, -0.112492f, -0.279553f, 0.172028f, 0.294719f, 0.007197f, -0.005851f, -0.077668f, -0.291364f, 0.008684f, 0.234192f, -0.020450f, -0.122614f, 0.348472f},
  {-0.295840f, -0.371281f, -0.504622f, -0.367496f, -0.089593f, -0.117036f, -0.033586f, 0.111251f, 0.182745f, -0.157194f, -0.429105f, 0.411917f, 0.400669f, 0.083399f, 0.194254f, 0.150568f, -0.021713f, -0.247351f, -0.138942f, 0.035090f, 0.101801f, -0.005033f, -0.089118f, -0.156033f, 0.023018f, -0.008821f, -0.059948f, 0.032068f, -0.051779f, 0.321328f, 0.278068f, -0.141700f, 0.718027f, 0.502037f, 0.622824f, 0.666322f, 0.066447f, 0.576477f, 0.467290f, -0.177907f, -0.411326f, 0.022686f, 0.142724f, -0.347251f, -0.644454f, -0.170945f, -0.103692f, -0.535013f},
  {0.429625f, 0.419228f, 0.392698f, 0.396998f, 0.237051f, -0.362039f, -0.249877f, 0.128081f, 0.135667f, 0.226450f, 0.128762f, 0.179293f, 0.241897f, 0.371796f, 0.294373f, 0.408350f, 0.231586f, 0.047764f, -0.059915f, 0.044948f, -0.133223f, 0.819302f, 1.041484f, 0.001497f, -0.346825f, 0.514174f, 0.412650f, -0.306966f, -0.290190f, -0.621141f, -0.513575f, -0.311167f, -0.427857f, -0.459273f, -0.251640f, -0.330993f, -0.079037f, -0.449585f, -0.459491f, -0.202317f, -0.460300f, 0.092790f, -0.017949f, -0.643983f, -0.467719f, -0.035932f, -0.171447f, -0.364509f},
  {-0.218474f, -0.254945f, -0.233224f, 0.093195f, 0.348815f, 0.419986f, 0.433846f, 0.119462f, 0.165546f, 0.356659f, 0.610271f, -0.152718f, 0.146178f, -0.413391f, -0.377161f, 0.198932f, 0.366892f, 0.409131f, 0.265070f, 0.549082f, 0.078170f, -0.428769f, -0.529007f, -0.172711f, -0.449925f, -0.625709f, -0.537159f, -0.790213f, 0.167662f, 0.147376f, 0.286593f, 0.183296f, 0.424416f, 0.227750f, 0.433623f, 0.634359f, -0.088193f, 0.119758f, 0.015883f, -0.292862f, -0.439856f, -0.361321f, -0.176301f, -0.577542f, 0.066865f, -0.044209f, -0.068453f, 0.087718f},
  {0.187268f, -0.066510f, -0.175708f, 0.185364f, 0.285774f, -0.133579f, -0.174980f, 0.236621f, 0.276706f, -0.048410f, 0.026833f, 0.093774f, -0.140411f, -0.250627f, -0.202594f, -0.015802f, 0.016709f, -0.245909f, -0.150114f, -0.134192f, -0.360424f, 0.677151f, 0.531892f, -0.284439f, -0.224121f, 0.070178f, 0.097617f, -0.258639f, 0.000841f, -0.185748f, -0.115186f, -0.073982f, -0.067798f, -0.350475f, -0.293595f, -0.034858f, -0.405250f, 1.107303f, 1.126161f, -0.344020f, -0.105537f, 0.205263f, -0.052880f, -0.038093f, 0.133446f, -0.387771f, -0.249997f, 0.105005f},
  {-0.115873f, 0.610726f, 0.497101f, -0.189482f, -0.221959f, 0.691962f, 0.636994f, -0.319398f, -0.319118f, 0.537081f, 0.368664f, -0.036260f, -0.255933f, 0.575777f, 0.529355f, -0.137367f, -0.219231f, -0.093749f, -0.071282f, -0.396007f, -0.256678f, -0.204056f, -0.060610f, -0.338179f, -0.440895f, 0.313869f, 0.203715f, -0.277910f, -0.504199f, 0.255640f, 0.216622f, -0.496071f, -0.230055f, 0.053628f, 0.220063f, -0.208563f, 0.079745f, 0.193437f, 0.295073f, -0.016169f, -0.276115f, 0.706777f, 0.480336f, -0.305131f, -0.137185f, 0.354064f, 0.431462f, -0.159568f},
  {0.025317f, -0.030845f, 0.027271f, 0.009076f, -0.152743f, 0.345543f, 0.394836f, -0.244384f, -0.206408f, -0.391282f, -0.392193f, -0.037171f, 0.353359f, 0.273827f, 0.308386f, 0.442969f, 0.142303f, 0.362418f, 0.302381f, 0.106704f, 0.422533f, -0.532635f, -0.509925f, 0.397521f, 0.900302f, 0.436396f, 0.320132f, 0.695581f, 0.331189f, 0.529579f, 0.396818f, 0.338388f, -0.330335f, -0.123867f, 0.061096f, -0.436365f, -0.300922f, 0.135217f, 0.240951f, -0.069589f, -0.596276f, -0.187971f, -0.256890f, -0.521517f, -1.022686f, -0.570170f, -0.549496f, -1.113702f},
  {0.283428f, -0.072301f, -0.070071f, 0.167359f, -0.232689f, -0.643397f, -0.562733f, -0.396218f, -0.297197f, 0.350952f, 0.542879f, -0.247258f, -0.389947f, 0.095287f, 0.180094f, -0.394341f, 0.241048f, 0.166105f, 0.229045f, 0.242476f, 0.405672f, 0.841807f, 0.697342f, 0.565622f, -0.001515f, -0.113444f, -0.159491f, 0.138598f, 0.142793f, -0.399503f, -0.391743f, 0.114427f, -0.190109f, -0.326480f, -0.252947f, -0.232192f, 0.197871f, -0.421586f, -0.510215f, 0.184263f, 0.150241f, -0.124359f, -0.182854f, -0.058928f, 0.294487f, -0.215960f, -0.201988f, 0.326761f},
  {0.116451f, -0.212787f, -0.147853f, 0.080487f, 0.164181f, -0.652141f, -0.631654f, 0.317427f, 0.170308f, -0.239202f, -0.006949f, 0.262321f, -0.096965f, -0.374819f, -0.124168f, -0.041936f, 0.032849f, 0.053824f, 0.005734f, -0.045302f, -0.039540f, -0.160102f, -0.162317f, -0.089152f, 0.137521f, 0.250093f, 0.100206f, 0.244510f, 0.018602f, 0.298724f, 0.159922f, -0.023589f, 0.468322f, 0.566665f, 0.522666f, 0.383528f, 0.259120f, 0.041716f, 0.015782f, 0.100863f, 0.128137f, -0.029517f, -0.217900f, 0.190701f, 0.026667f, 0.341100f, 0.459257f, 0.042688f},
  {-0.045867f, 0.019030f, 0.106659f, -0.274816f, -0.557490f, 0.287837f, 0.602265f, 0.066585f, -0.082538f, 0.413872f, 0.106833f, 0.178435f, -0.186834f, -0.349523f, -0.551988f, -0.131166f, 0.502721f, 0.016360f, -0.028703f, 0.269067f, -0.140269f, -0.110888f, 0.146176f, 0.029066f, -0.134693f, 0.308682f, 0.336813f, 0.068192f, 0.010019f, -0.118743f, -0.144371f, -0.058144f, 0.601086f, 0.113739f, 0.088123f, 0.234173f, -0.300311f, -0.574286f, -0.557232f, -0.191512f, -0.231173f, -0.089814f, -0.013260f, -0.161530f, 0.316389f, 0.000957f, -0.093495f, 0.207581f},
  {-0.167444f, -0.332875f, -0.295744f, 0.042468f, -0.400447f, -0.089983f, -0.039814f, -0.329284f, -0.311960f, 0.151166f, 0.194624f, -0.463904f, -0.899036f, -0.190181f, -0.099412f, -0.831364f, -0.188328f, -0.236225f, -0.204735f, -0.212701f, -0.123269f, -0.075287f, 0.104799f, -0.157548f, -0.090519f, 0.194165f, 0.310942f, 0.015045f, -0.062220f, 0.431556f, 0.443217f, -0.201598f, 0.511014f, 0.405286f, 0.324811f, 0.293328f, 0.445261f, 0.021572f, -0.221249f, 0.362520f, 0.227176f, -0.202488f, -0.110090f, 0.082629f, 0.224357f, 0.583996f, 0.474709f, 0.264517f},
  {0.302432f, 0.115663f, 0.056851f, 0.266449f, 0.512430f, -0.447632f, -0.463906f, 0.488194f, -0.034601f, -0.356060f, -0.230680f, -0.174393f, 0.253489f, 0.273696f, 0.164209f, 0.096789f, 0.110928f, -0.465438f, -0.271466f, 0.214889f, 0.494742f, -1.007996f, -1.125506f, 0.415997f, 0.053073f, 0.021082f, 0.107906f, -0.021748f, -0.383018f, -0.291086f, -0.289019f, -0.161756f, 0.198935f, -0.131631f, -0.155770f, 0.228808f, 0.605094f, -0.783115f, -0.594258f, 0.472043f, 0.032908f, -0.060762f, -0.027396f, 0.123432f, 0.035731f, 0.253036f, 0.408009f, 0.069271f},
  {-0.167121f, -0.323690f, -0.335362f, -0.371216f, 0.005048f, 0.482150f, 0.462621f, 0.012793f, -0.263327f, 0.726734f, 0.865120f, 0.025167f, 0.071952f, -0.272242f, -0.328446f, 0.333994f, -0.071133f, 0.181888f, 0.129834f, -0.175447f, -0.287108f, 0.360539f, 0.477580f, -0.367733f, -0.384480f, -0.056287f, -0.270100f, -0.310342f, 0.486105f, 0.239760f, 0.139627f, 0.283996f, 0.218881f, -0.041735f, -0.125647f, 0.044555f, 0.041717f, -0.620163f, -0.397667f, 0.019407f, -0.079870f, -0.624545f, -0.818096f, -0.039044f, 0.175653f, -0.076530f, -0.057471f, 0.117541f},
  {0.009277f, 0.363865f, 0.327480f, 0.245323f, 0.047435f, 0.110761f, -0.001060f, -0.016045f, 0.297547f, -0.152922f, -0.317948f, 0.341420f, -0.276015f, 0.318929f, 0.003820f, -0.139852f, -0.096070f, 0.165990f, 0.144452f, -0.206969f, -0.035265f, 0.202658f, 0.402192f, -0.050486f, 0.472944f, -0.092128f, 0.050621f, 0.492102f, 0.176288f, -0.082237f, -0.185801f, 0.005205f, 0.198214f, 0.178718f, 0.340239f, 0.081957f, 0.339999f, -0.373861f, -0.203637f, 0.315137f, 0.446345f, -0.626725f, -0.534172f, 0.452216f, 0.454380f, -0.267406f, -0.155754f, 0.347734f},
};

// FC1 Bias [16]
float fc1_bias[16] = {
  0.713960f,
  0.035149f,
  0.049238f,
  0.345178f,
  0.323611f,
  -0.023218f,
  0.159028f,
  0.395713f,
  0.403409f,
  0.632938f,
  0.275843f,
  0.119314f,
  0.644942f,
  0.365421f,
  0.312134f,
  0.482096f
};

// FC2 Weight [10][16]
float fc2_weight[10][16] = {
  {0.258049f, 0.263407f, -0.047166f, 0.394025f, 0.544857f, -0.291708f, 0.237101f, -0.849085f, -0.004604f, -0.978353f, 0.616537f, -0.110476f, 0.666521f, -0.552776f, -0.569975f, 0.250655f},
  {1.722638f, 0.724046f, 1.028867f, -0.153494f, -0.175647f, 0.528541f, 0.480643f, -0.813655f, -0.874594f, -0.321292f, 0.291627f, -0.183978f, -1.141536f, -0.444395f, 0.759586f, -0.773219f},
  {-0.452096f, -0.501564f, -0.882965f, -0.255769f, 0.377491f, -0.846199f, -0.430369f, -0.303527f, 0.553268f, 0.728753f, 0.303210f, -0.694107f, 0.465763f, -0.166761f, -0.416970f, 0.488669f},
  {-0.645533f, -0.147316f, -0.629589f, -0.629387f, 0.612766f, -0.439732f, -0.427238f, 0.516262f, -0.459545f, -0.079252f, -0.604425f, -0.116286f, 0.229620f, 0.559920f, -0.063115f, 0.403492f},
  {-0.825640f, -0.283500f, -0.261110f, -0.044245f, -0.096736f, -0.424335f, -1.153854f, -0.367812f, 0.672635f, 0.390714f, 0.218441f, -0.822462f, 0.281884f, -0.608115f, 0.250160f, 0.080279f},
  {-0.647438f, -0.307856f, -0.294862f, -0.710200f, 0.017623f, -0.498252f, -0.170865f, 0.923374f, 0.138013f, 0.020615f, -0.649053f, -0.039109f, -0.097629f, 0.528379f, -0.234940f, 0.333559f},
  {-1.819177f, -0.354727f, -1.495923f, -1.824242f, 0.732572f, -0.393293f, -0.048837f, -0.073464f, -0.153568f, 0.838089f, 0.277766f, -0.067237f, 0.009581f, 0.090590f, 0.412913f, 0.330163f},
  {-0.707176f, -0.987810f, -0.339989f, 0.181387f, -0.763961f, 0.234190f, 0.715066f, -0.089211f, 1.005570f, -1.376312f, -0.096439f, 0.221955f, -0.472664f, 0.669385f, 0.006019f, -0.108318f},
  {-0.045696f, 0.510170f, 0.610296f, 0.192952f, -0.787367f, 0.195917f, 0.132735f, 0.080709f, -1.135800f, 1.019238f, -0.163187f, 0.359911f, 0.540577f, -1.335925f, -0.784446f, 0.176598f},
  {1.003300f, 0.315822f, 0.384519f, 0.750103f, -0.225140f, 0.588944f, 0.002496f, -0.336594f, -1.015375f, -0.324056f, -0.244216f, 0.618868f, -1.087565f, -0.084491f, 0.411606f, -0.534774f},
};

// FC2 Bias [10]
float fc2_bias[10] = {
  -0.240052f,
  -0.419769f,
  -0.085902f,
  0.217127f,
  0.443556f,
  0.033482f,
  -0.201010f,
  0.312124f,
  -0.268377f,
  -0.150925f
};

// Neural network inference function (CIFAR-10)
int cifar10_classify(uint8_t inputNN[32][32][3], float *confidence)
{
    // Step 1: Average pooling to reduce 32x32x3 to 4x4x3 = 48 features
    float pooled_features[48];

    for (int c = 0; c < 3; c++) {  // For each channel (R, G, B)
        for (int y = 0; y < 4; y++) {  // 4x4 output
            for (int x = 0; x < 4; x++) {
                float sum = 0.0f;
                // Average over 8x8 window
                for (int dy = 0; dy < 8; dy++) {
                    for (int dx = 0; dx < 8; dx++) {
                        int input_y = y * 8 + dy;
                        int input_x = x * 8 + dx;
                        sum += (float)inputNN[input_y][input_x][c] / 255.0f; // Normalize to [0,1]
                    }
                }
                int output_idx = c * 16 + y * 4 + x;  // 4x4x3 flattened
                pooled_features[output_idx] = (sum / 64.0f) * 2.0f - 1.0f; // Normalize to [-1,1]
            }
        }
    }

    // Step 2: First fully connected layer (48 -> 16)
    float fc1_output[16];
    for (int i = 0; i < 16; i++) {
        fc1_output[i] = fc1_bias[i];
        for (int j = 0; j < 48; j++) {
            fc1_output[i] += fc1_weight[i][j] * pooled_features[j];
        }
        // ReLU activation
        fc1_output[i] = fc1_output[i] > 0.0f ? fc1_output[i] : 0.0f;
    }

    // Step 3: Second fully connected layer (16 -> 10)
    float fc2_output[10];
    for (int i = 0; i < 10; i++) {
        fc2_output[i] = fc2_bias[i];
        for (int j = 0; j < 16; j++) {
            fc2_output[i] += fc2_weight[i][j] * fc1_output[j];
        }
    }

    // Step 4: Softmax (find max for numerical stability)
    float max_val = fc2_output[0];
    for (int i = 1; i < 10; i++) {
        if (fc2_output[i] > max_val) {
            max_val = fc2_output[i];
        }
    }

    // Calculate softmax probabilities
    float sum = 0.0f;
    float probabilities[10];
    for (int i = 0; i < 10; i++) {
        probabilities[i] = expf(fc2_output[i] - max_val);
        sum += probabilities[i];
    }

    // Normalize probabilities
    for (int i = 0; i < 10; i++) {
        probabilities[i] /= sum;
    }

    // Find the class with highest probability
    int predicted_class = 0;
    float max_confidence = probabilities[0];
    for (int i = 1; i < 10; i++) {
        if (probabilities[i] > max_confidence) {
            max_confidence = probabilities[i];
            predicted_class = i;
        }
    }

    // Return the confidence score
    *confidence = max_confidence;

    return predicted_class;
}
